var app=function(){"use strict";function t(){}function e(t){return t()}function n(){return Object.create(null)}function i(t){t.forEach(e)}function s(t){return"function"==typeof t}function o(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function r(t,e){t.appendChild(e)}function a(t){t.parentNode.removeChild(t)}function h(t){return document.createElement(t)}function c(t){return document.createTextNode(t)}function l(){return c(" ")}function d(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function u(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}function p(t,e,n,i){t.style.setProperty(e,n,i?"important":"")}let f;function g(t){f=t}function y(t){(function(){if(!f)throw new Error("Function called outside component initialization");return f})().$$.on_mount.push(t)}const x=[],m=[],b=[],v=[],w=Promise.resolve();let $=!1;function k(t){b.push(t)}let _=!1;const S=new Set;function D(){if(!_){_=!0;do{for(let t=0;t<x.length;t+=1){const e=x[t];g(e),H(e.$$)}for(g(null),x.length=0;m.length;)m.pop()();for(let t=0;t<b.length;t+=1){const e=b[t];S.has(e)||(S.add(e),e())}b.length=0}while(x.length);for(;v.length;)v.pop()();$=!1,_=!1,S.clear()}}function H(t){if(null!==t.fragment){t.update(),i(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(k)}}const M=new Set;function O(t,e){-1===t.$$.dirty[0]&&(x.push(t),$||($=!0,w.then(D)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function C(o,r,h,c,l,d,u=[-1]){const p=f;g(o);const y=r.props||{},x=o.$$={fragment:null,ctx:null,props:d,update:t,not_equal:l,bound:n(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(p?p.$$.context:[]),callbacks:n(),dirty:u,skip_bound:!1};let m=!1;if(x.ctx=h?h(o,y,((t,e,...n)=>{const i=n.length?n[0]:e;return x.ctx&&l(x.ctx[t],x.ctx[t]=i)&&(!x.skip_bound&&x.bound[t]&&x.bound[t](i),m&&O(o,t)),e})):[],x.update(),m=!0,i(x.before_update),x.fragment=!!c&&c(x.ctx),r.target){if(r.hydrate){const t=function(t){return Array.from(t.childNodes)}(r.target);x.fragment&&x.fragment.l(t),t.forEach(a)}else x.fragment&&x.fragment.c();r.intro&&((b=o.$$.fragment)&&b.i&&(M.delete(b),b.i(v))),function(t,n,o){const{fragment:r,on_mount:a,on_destroy:h,after_update:c}=t.$$;r&&r.m(n,o),k((()=>{const n=a.map(e).filter(s);h?h.push(...n):i(n),t.$$.on_mount=[]})),c.forEach(k)}(o,r.target,r.anchor),D()}var b,v;g(p)}let F={width:640,height:480};class A{constructor(){this.audioContext=new AudioContext,this.panner=this.audioContext.createStereoPanner(),this.gain=this.audioContext.createGain(),this.masterGain=this.audioContext.createGain(),this.panner.connect(this.gain),this.gain.connect(this.masterGain),this.masterGain.connect(this.audioContext.destination),this.masterGain.gain.value=.5,this.gain.gain.value=.5,this.playing=!1}start(){this.oscillator=this.audioContext.createOscillator(),this.oscillator.connect(this.panner),this.oscillator.type="sawtooth",this.oscillator.frequency.value=440,this.beepGain=this.audioContext.createGain(),this.beepGain.gain.value=.5,this.beepOscillator=this.audioContext.createOscillator(),this.beepOscillator.connect(this.beepGain),this.beepOscillator.frequency.value=3,this.beepOscillator.type="square",this.beepGain.connect(this.gain.gain),this.oscillator.start(),this.beepOscillator.start(),this.playing=!0}stop(){this.oscillator.stop(),this.beepOscillator.stop(),this.playing=!1}setFrequency(t){this.oscillator&&(this.oscillator.frequency.value=t)}setPan(t){this.panner.pan.value=t}setBeepingFrequency(t){this.beepOscillator&&(this.beepOscillator.frequency.value=t)}setMasterGain(t){this.masterGain.gain.value=t}}class E{constructor(){this.state=-1,this.status="Click on play",this.targetDoorCenterX=F.width/2,this.targetDoorCenterY=F.height/2,this.targetDoorHeight=.9*F.height,this.targetHandleCenterX=F.width/2,this.targetHandleCenterY=F.height/2,this.targetHandleArea=F.width*F.height*.4,this.DOOR_LABEL=1,this.HANDLE_LABEL=77,this.currentDoor=null,this.currentHandle=null,this.synth=new A,this.speechSynthesis=window.speechSynthesis,this.speechSynthesis.addEventListener("voiceschanged",(()=>{const t=this.speechSynthesis.getVoices();this.voice=t[0];for(let e of t)"en-US"==e.lang&&(this.voice=e)}))}speak(t){let e=new SpeechSynthesisUtterance(t);e.voice=this.voice,speechSynthesis.speak(e)}setState(t){if(console.log("Setting state "+t),t!=this.state)switch(this.speechSynthesis.pause(),this.speechSynthesis.cancel(),this.state=t,t){case 0:this.status="Looking for door",this.speak("Please look around to find a door");break;case 1:this.status="Door found !",this.speak("I found a door ! I'll guide you with the beeps");break;case 2:this.status="Handle found !",this.speak("I found the handle ! Now I'll guide you to it")}}update(t){this.speechSynthesis.speaking?this.synth.setMasterGain(.1):this.synth.setMasterGain(.8),this.currentDoor=this.lookForDoor(t),0==this.state?this.currentDoor&&(this.setState(1),this.synth.start()):1==this.state?(this.currentHandle=this.lookForHandle(t),this.currentHandle?this.setState(2):this.currentDoor?this.guideTowardsDoor():(this.setState(0),this.synth.stop())):2==this.state&&(this.currentHandle=this.lookForHandle(t),this.currentHandle?this.guideTowardsHandle():this.setState(1))}lookForDoor(t){return this.lookForObject(t,this.DOOR_LABEL)}lookForHandle(t){return this.lookForObject(t,this.HANDLE_LABEL)}lookForObject(t,e){let n=t.filter((t=>t.label==e));if(n.length<=0)return null;let i=n[0],s=i.confidence;for(let t of n)t.confidence>s&&(s=t.confidence,i=t);return i}guideTowardsDoor(){let t=this.targetDoorCenterX-this.currentDoor.centerX,e=this.targetDoorCenterY-this.currentDoor.centerY,n=this.currentDoor.height/this.targetDoorHeight;this.synth.setBeepingFrequency(5*n);let i=e/(F.height/2),s=440+220*Math.round(i);this.synth.setFrequency(s);let o=t/F.width*-1;this.synth.setPan(Math.pow(Math.abs(o),.2)*Math.sign(o)),this.status=`\n            Door center at (${this.currentDoor.centerX.toFixed(3)};${this.currentDoor.centerY.toFixed(3)})\n            Move requested (${t.toFixed(3)};${e.toFixed(3)})\n            Door height (${this.currentDoor.height.toFixed(3)})\n            Door distance target (${n.toFixed(3)})\n        `}guideTowardsHandle(){let t=this.targetHandleCenterX-this.currentHandle.centerX,e=this.targetHandleCenterY-this.currentHandle.centerY,n=this.currentHandle.area/this.targetHandleArea;this.synth.setBeepingFrequency(5*n);let i=e/(F.height/2),s=440+220*Math.round(i);this.synth.setFrequency(s);let o=t/F.width*-1;this.synth.setPan(Math.pow(Math.abs(o),.2)*Math.sign(o)),this.status=`\n            Handle center at (${this.currentHandle.centerX.toFixed(3)};${this.currentHandle.centerY.toFixed(3)})\n            Move requested (${t.toFixed(3)};${e.toFixed(3)})\n            Handle area (${this.currentHandle.height.toFixed(3)})\n            Handle distance target (${n.toFixed(3)})\n        `}}class G{constructor(t,e,n,i,s,o){this.label=t,this.confidence=e,this.x=n*F.width,this.xMax=i*F.width,this.y=s*F.height,this.yMax=o*F.height,this.width=this.xMax-this.x,this.height=this.yMax-this.y,this.centerX=this.x+this.width/2,this.centerY=this.y+this.height/2,this.area=this.width*this.height}}class L{constructor(t){this.model=null,this.options=t||{N_CLASS:4,MIN_SCORE:.2,MAX_DRAW_BOX:20}}async loadModel(){this.model=await tf.loadGraphModel("./web_model/model.json"),console.log("[Object detector] model loaded")}async detect(t){tf.engine().startScope();let e=tf.browser.fromPixels(t).resizeNearestNeighbor([320,320]).expandDims(),n=await this.model.executeAsync(e),i=this.model.outputNodes.indexOf("Identity_1:0"),s=this.model.outputNodes.indexOf("Identity_2:0"),o=this.model.outputNodes.indexOf("Identity_4:0"),r=n[i].array().then((t=>t[0])),a=n[s].array().then((t=>t[0])),h=n[o].array().then((t=>t[0])),[c,l,d]=await Promise.all([r,a,h]),u=[];for(let t=0,e=0;e<c.length;e++){let n=l[e];if(0==n||n>this.options.N_CLASSES)continue;let i=d[e];if(i<this.options.MIN_SCORE)break;let s=c[e];if(u.push(new G(n,i,s[1],s[3],s[0],s[2])),++t>=this.options.MAX_DRAW_BOX)break}return tf.engine().endScope(),u}}function N(e){let n,i,s,o,f,g,y,x,m,b,v,w,$,k,_,S,D,H,M,O,C,F=e[5]?"Stop guidance":"Guide me";return{c(){n=h("div"),i=h("main"),s=h("h1"),s.textContent="TrainGuide proof of concept",o=l(),f=h("section"),g=h("h2"),y=c("Video input : "),x=c(e[3]),m=l(),b=h("div"),v=h("video"),w=l(),$=h("canvas"),k=l(),_=h("button"),S=c(F),D=l(),H=h("p"),M=c(e[4]),d(s,"class","svelte-ekpxce"),v.autoplay=!0,d(v,"id","input-video"),d(v,"class","svelte-ekpxce"),d($,"id","objects-canvas"),d($,"class","svelte-ekpxce"),d(b,"id","video-container"),p(b,"height",Math.max(200,e[0].height)+"px"),d(b,"class","svelte-ekpxce"),d(_,"class","svelte-ekpxce"),d(H,"class","svelte-ekpxce"),d(i,"class","svelte-ekpxce"),d(n,"id","wrapper"),d(n,"class","svelte-ekpxce")},m(t,a){var h,c,l,d;!function(t,e,n){t.insertBefore(e,n||null)}(t,n,a),r(n,i),r(i,s),r(i,o),r(i,f),r(f,g),r(g,y),r(g,x),r(f,m),r(f,b),r(b,v),e[7](v),r(b,w),r(b,$),e[8]($),r(f,k),r(f,_),r(_,S),r(f,D),r(f,H),r(H,M),O||(h=_,c="click",l=e[6],h.addEventListener(c,l,d),C=()=>h.removeEventListener(c,l,d),O=!0)},p(t,[e]){8&e&&u(x,t[3]),1&e&&p(b,"height",Math.max(200,t[0].height)+"px"),32&e&&F!==(F=t[5]?"Stop guidance":"Guide me")&&u(S,F),16&e&&u(M,t[4])},i:t,o:t,d(t){t&&a(n),e[7](null),e[8](null),O=!1,C()}}}function X(t,e,n){const i={video:{facingMode:"environment"}};let s=null,o=null,r=null,a=new L({N_CLASS:4,MIN_SCORE:.4,MAX_DRAW_BOX:20});console.log(a);let h=new E,c="";y((async()=>{r=o.getContext("2d"),navigator.mediaDevices.getUserMedia(i).then((t=>{n(1,s.srcObject=t,s),n(3,c=t.getVideoTracks()[0].label)})),await a.loadModel()}));let l="Click on play";async function d(){if(!u)return;let t=await a.detect(s);!function(t){r.clearRect(0,0,F.width,F.height),r.strokeStyle="red",r.strokeWidth=3,r.font='20px "Segoe UI"';for(let e of t)r.strokeRect(e.x,e.y,e.width,e.height),r.fillText(e.label+" ("+e.confidence+")",e.x,e.y-10),r.beginPath(),r.arc(e.centerX,e.centerY,20,0,2*Math.PI),r.fill()}(t),h.update(t),n(4,l=h.status),requestAnimationFrame(d)}let u=!1;return[F,s,o,c,l,u,function(){u?n(5,u=!1):(n(5,u=!0),n(0,F.width=s.videoWidth,F),n(0,F.height=s.videoHeight,F),n(2,o.width=s.videoWidth,o),n(2,o.height=s.videoHeight,o),n(2,o.style.width=s.videoWidth+"px",o),n(2,o.style.height=s.videoHeight+"px",o),h.setState(0),d())},function(t){m[t?"unshift":"push"]((()=>{s=t,n(1,s)}))},function(t){m[t?"unshift":"push"]((()=>{o=t,n(2,o)}))}]}return new class extends class{$destroy(){!function(t,e){const n=t.$$;null!==n.fragment&&(i(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=t}$on(t,e){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(e),()=>{const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}{constructor(t){super(),C(this,t,X,N,o,{})}}({target:document.body,props:{}})}();
//# sourceMappingURL=bundle.js.map
